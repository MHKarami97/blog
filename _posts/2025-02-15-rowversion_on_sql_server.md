---
title: "ุฒูุงู ููุฏุงุฑุฏู ID , RowVersion ุฏุฑ SQL Server"
categories:
  - SQL
tags:
  - sql
  - row_version
  - transaction
---

ุฏุฑ ุตูุฑุช ฺฉู ุฏุฑ ุณุณุชู ุฎูุฏ ุจุฒูุณ ุดุจู ุจู ุญุงูุช ุฒุฑ ุฏุงุฑุฏ ุจู ูฺฉุชูโุง ฺฉู ุฏุฑ ุงุฏุงูู ุขู ุชูุถุญ ุฏุงุฏู ูโุดูุฏ ูุงุฒ ุงุณุช ฺฉู ุฏูุช ฺฉูุฏ:  
ุฏุงุดุชู ฺฉ SP ฺฉู ุจุง ฺฉ ุงูุชุฑูุงู ุฒูุงู ุชูุงู ุณุทุฑูุง ฺฉู ุฏุฑ ุดุฑุท `Id > x` ุง `RowVersion > x` ุฑุง ุฏุฑุงูุช ฺฉูุฏ ฺฉู ุฏุฑ ุขู x ุขุฎุฑู ุดูุงุณู ุฎูุงูุฏู ุดุฏู ุฏุฑ ุฒูุงู ูุจู ุงุณุช.  
ุจุทูุฑ ูุซุงู ุฏุฑ ุฒูุงู 1 ุดูุง sp ุฑุง ุจุง x=0 ูุฑุงุฎูุงู ูโฺฉูุฏ ู 10 ุฑฺฉูุฑุฏ ุจู ุดูุง ุจุฑูโฺฏุฑุฏุงูุฏ.  
ุฏุฑ ุฒูุงู 2 ุดูุง ุฏูุจุงุฑู sp ุฑุง ุจุง x=10 ูุฑุงุฎูุงู ูโฺฉูุฏ.  
ุฏุฑ ุงู ุญุงูุช ููฺฉู ุงุณุช ุจุนุถ ุณุทุฑูุง ุฑุง ฺฉูุง ุฏุฑุงูุช ูฺฉูุฏ ฺฉู ุฏูู ุงู ูุดฺฉู ุฏุฑ ุงุฏุงูู ุจุงู ูโุดูุฏ.  

ููุฏุงุฑุฏู ุจู Id ุง RowVersion ุฏุฑ ุฒูุงู ูุฑุงุฎูุงู ุฏุณุชูุฑ INSERT ุงุณุช ูู ุฒูุงู COMMIT ุชุฑุงฺฉูุด. ุจุทูุฑ ูุซุงู ุฏุฑ ฺฉุฏ ุฒุฑ ุจู ูุญุถ ูุฑุงุฎูุงู INSERT ููุฏุงุฑ Id ุฏุฑุงูุช ูโุดูุฏ.  

```sql
BEGIN TRANSACTION T1;

INSERT INTO #TempProducts (Name, Price)
VALUES ('Product T1', 1000);


COMMIT TRANSACTION T1;
```

ุฏุฑ ุตูุฑุช ฺฉู ุชุนุฏุงุฏ ุชุบุฑุงุช ุฏุฑ ุฌุฏูู ุฏุชุงุจุณ ุดูุง ุฒุงุฏ ุงุณุช ู ุจุตูุฑุช ููุฒูุงู ุงูุฒุชโูุง ูุฎุชูู ุฏุฑ ุชุฑุงฺฉูุดโูุง ูุฎุชูู ุงุชูุงู ูโุงูุชุฏุ ุฏุฑ ุตูุฑุช ฺฉู ุชุฑุงฺฉูุด ุฒุงุฏ ุทูู ุจฺฉุดุฏ ููฺฉู ุงุณุช ุฑฺฉูุฑุฏ ุขู ุฏุฑ ุณูุงุฑู ฺฏูุชู ุดุฏู ุฏุฑ ุจุงูุง ุฏุฑุงูุช ูุดูุฏ.  
ุจุทูุฑ ูุซุงู ฺฉุฏ ุฒุฑ ุฑุง ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ.  


```sql
-- ุงุฌุงุฏ ุฌุฏูู ูููุช ุจุง ุณุชูู RowVersion
CREATE TABLE #TempProducts
(
    Id         INT IDENTITY PRIMARY KEY,
    Name       NVARCHAR(100),
    Price      DECIMAL(10, 2),
    RowVersion ROWVERSION
);

-- ๐น ุดุฑูุน ุชุฑุงฺฉูุด T1
BEGIN TRANSACTION T1;

INSERT INTO #TempProducts (Name, Price)
VALUES ('Product T1', 1000);

SELECT SCOPE_IDENTITY() AS NewId, RowVersion
FROM #TempProducts
WHERE Name = 'Product T1';

-- ููุฏุงุฑ RowVersion ุฏุฑ ููู ุชุฑุงฺฉูุด ููุฏุงุฑุฏู ุดุฏู ูู ูููุฒ COMMIT ูุดุฏู ุงุณุช

-- ๐น ุดุฑูุน ุชุฑุงฺฉูุด T2 (ูุจู ุงุฒ COMMIT ุดุฏู T1)
BEGIN TRANSACTION T2;

INSERT INTO #TempProducts (Name, Price)
VALUES ('Product T2', 2000);
-- ููุฏุงุฑ RowVersion ุจุฑุง ุงู ุฑฺฉูุฑุฏ ููุฏุงุฑุฏู ุดุฏู ูู ูููุฒ COMMIT ูุดุฏู

-- ๐น COMMIT ฺฉุฑุฏู T1 ูุจู ุงุฒ T2
COMMIT TRANSACTION T2;

-- โณ ุชุฃุฎุฑ ฑ ุซุงูู
WAITFOR DELAY '00:00:01';

-- ๐น ููุฏุงุฑ RowVersion ูุนู ุฑุง ุฐุฎุฑู ูโฺฉูู
DECLARE @CurrentRowVersion VARBINARY(8);
SELECT @CurrentRowVersion = MAX(RowVersion)
FROM #TempProducts;

-- ๐น ุฏุฑุงูุช ุชูุงู ุณุทุฑูุง ฺฉู RowVersion ุฌุฏุฏุชุฑ ุฏุงุฑูุฏ
SELECT *
FROM #TempProducts
WHERE RowVersion > @CurrentRowVersion;
-- ุฏุฑ ุงูุฌุง ููุฏุงุฑ ูุฑุจูุท ุจู T1 ููุงุด ุฏุงุฏู ููโุดูุฏ ฺูู ูููุฒ COMMIT ูุดุฏู

-- ๐น ุญุงูุง T1 ุฑุง COMMIT ูโฺฉูู
COMMIT TRANSACTION T1;

-- ๐น ุจุนุฏ ุงุฒ COMMIT ุดุฏู T1 ุฏูุจุงุฑู ฺฺฉ ูโฺฉูู
SELECT *
FROM #TempProducts
WHERE RowVersion > @CurrentRowVersion;

-- ๐ ูพุงฺฉ ฺฉุฑุฏู ุฌุฏูู ูููุช
DROP TABLE #TempProducts;
```

ุฏุฑ ฺฉุฏ ุจุงูุง ุฏู ุชุฑุงฺฉูุด T1, T2 ุฑุง ุฏุงุฑู ฺฉู ูุฑ ุฏู ุฏุฑ ุฌุฏูู ฺฉ ุณุทุฑ ุฌุฏุฏ ุงุฌุงุฏ ูโฺฉููุฏ. ุชุฑุงฺฉูุด T1 ูุจู ุงุฒ T2 ู ุฒูุฏุชุฑ ุดุฑูุน ูโุดูุฏ ุงูุง ุจุนุฏ ุงุฒ ุชุฑุงฺฉูุด T2 ุฏุฑ ุฏุชุงุจุณ COMMIT ูโุดูุฏ.  
ุฏุฑ ุงู ุญุงูุช ุดูุงุณู ุชุฎุตุต ุฏุงุฏู ุดุฏู ุจู ุขู ฺฉูฺฺฉุชุฑ ุงุณุช. ุจุทูุฑ ูุซุงู:  
 - T1 => Id=1
 - T2 => Id=2

ุฏุฑ ุตูุฑุช ฺฉู ุชุบุฑุงุช ุฑุง ูุจู ุงุฒ ฺฉุงูุช ุชุฑุงฺฉูุด T1 ู ุจุนุฏ ุงุฒ ฺฉุงูุช ุดุฏู ุชุฑุงฺฉูุด T2 ุจุฎูุงูุฏ ุณุทุฑ ุญุงุตู ุงุฒ T2 ุฑุง ุฏุฑุงูุช ูโฺฉูุฏ ูู ุณุทุฑ T1 ุฏุฑุงูุช ููโุดูุฏ.  
ููฺูู ุจุง ุชูุฌู ุจู ุงูฺฉู ุดูุงุณู T2 ุฑุง ุจุฑุง ูุฑุงุฎูุงูโูุง ุขูุฏู ุฐุฎุฑู ฺฉุฑุฏูโุงุฏ ุฏฺฏุฑ ุณุทุฑ T1 ุฑุง ุฏุฑ ุขูุฏู ุฏุฑุงูุช ูุฎูุงูุฏ ฺฉุฑุฏ.  